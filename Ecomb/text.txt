from rest_framework.decorators import api_view,  permission_classes
from rest_framework.response import Response 
from rest_framework_simplejwt.views import TokenObtainPairView
from .models import Products
from django.contrib.auth.models import User
from django.contrib.auth.hashers import make_password


from rest_framework.permissions import IsAuthenticated
from .serializers import ProductSerializers, UserSerializers, UserSerializerWithToken
from rest_framework_simplejwt.views import TokenObtainPairView
from rest_framework.response import Response
from rest_framework import status

from .serializers import MyTokenObtainPairSerializer

from rest_framework.views import APIView
from rest_framework.response import Response
from django.http import HttpRequest  
from rest_framework.permissions import IsAuthenticated, IsAdminUser

# to send mails and generate token.
from django.template.loader  import render_to_string
from django.utils.http import urlsafe_base64_decode, urlsafe_base64_encode
from utils import TokenGenerate, generate_token
from django.utils.encoding import force_bytes, force_text, DjangoUnicodeDecodeError
from django.core.mail import EmailMessage
from django.conf import settings
from django.views.generic import View


@api_view(['POST'])
def register(request: HttpRequest):  # Specify HttpRequest as parameter type
    if request.method == 'POST':
        serializer = UserSerializers(data=request.data)
        #generating token 
        email_subject = "Activate your account"
        message = render_to_string("activate.html")
        if serializer.is_valid():
            serializer.save()
            return Response(serializer.data, status=status.HTTP_201_CREATED)
        return Response(serializer.errors, status=status.HTTP_400_BAD_REQUEST)


@api_view(["GET"])
@permission_classes([IsAdminUser])
def getUsers(request):
    user = User.objects.all()
    serializer = UserSerializers(user, many=True)
    return Response(serializer.data)


class GetUserProfile(APIView):
    permission_classes = [IsAuthenticated]

    def get(self, request):
        user = request.user
        serializer = UserSerializers(user)
        return Response(serializer.data)

class MyTokenObtainPairView(TokenObtainPairView):
    serializer_class = MyTokenObtainPairSerializer

    def post(self, request, *args, **kwargs):
        serializer = self.get_serializer(data=request.data)
        if serializer.is_valid():
            user = serializer.validated_data['user']
            tokens = serializer.validated_data['tokens']

            # Serialize the user object
            user_serializer = UserSerializers(user)

            # Construct the response data
            response_data = {
                'user': user_serializer.data,  # Include the serialized user data
                'tokens': tokens  # Include the tokens
            }
            return Response(response_data, status=status.HTTP_200_OK)
        return Response(serializer.errors, status=status.HTTP_400_BAD_REQUEST)

 
@api_view(["GET"])
def getproducts(request):
    products = Products.objects.all()
    serializer = ProductSerializers(products, many=True)
    return Response(serializer.data)

@api_view(["GET"])
def getproduct(request, pk):
    product = Products.objects.get(id=pk)
    serializer = ProductSerializers(product)
    return Response(serializer.data)
